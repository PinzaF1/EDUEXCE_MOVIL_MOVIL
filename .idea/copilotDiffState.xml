<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/zavira_movil/niveleshome/QuizActivity.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/zavira_movil/niveleshome/QuizActivity.java" />
              <option name="originalContent" value="package com.example.zavira_movil.niveleshome;&#10;&#10;import android.app.AlertDialog;&#10;import android.content.Context;&#10;import android.graphics.Color;&#10;import android.graphics.drawable.ColorDrawable;&#10;import android.os.Bundle;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.widget.ImageView;&#10;import android.widget.LinearLayout;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.core.content.ContextCompat;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;&#10;import com.example.zavira_movil.QuizQuestionsAdapter;&#10;import com.example.zavira_movil.R;&#10;import com.example.zavira_movil.databinding.ActivityQuizBinding;&#10;import com.example.zavira_movil.local.UserSession;&#10;import com.example.zavira_movil.model.Question;&#10;import com.example.zavira_movil.remote.ApiService;&#10;import com.example.zavira_movil.remote.RetrofitClient;&#10;import com.google.android.material.button.MaterialButton;&#10;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.HashMap;&#10;import java.util.List;&#10;import java.util.Map;&#10;&#10;import okhttp3.ResponseBody;&#10;import retrofit2.Call;&#10;import retrofit2.Callback;&#10;import retrofit2.Response;&#10;&#10;/** Crea sesión, carga máx 10 preguntas, envía y desbloquea/retrocede según puntaje. */&#10;public class QuizActivity extends AppCompatActivity {&#10;&#10;    public static final String EXTRA_AREA    = &quot;extra_area&quot;;     // área visible UI&#10;    public static final String EXTRA_SUBTEMA = &quot;extra_subtema&quot;;  // subtema visible UI&#10;    public static final String EXTRA_NIVEL   = &quot;extra_nivel&quot;;    // 1..5&#10;&#10;    private ActivityQuizBinding binding;&#10;    private QuizQuestionsAdapter adapter;&#10;    private Integer idSesion;&#10;&#10;    private String areaUi, subtemaUi; // usamos UI para ProgressLockManager&#10;    private int nivel;&#10;    private int currentQuestionIndex = 0; // Índice de la pregunta actual&#10;    private List&lt;Question&gt; allQuestions = new ArrayList&lt;&gt;(); // Todas las preguntas&#10;    private List&lt;String&gt; todasLasRespuestas = new ArrayList&lt;&gt;(); // Respuestas guardadas mientras avanza&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        binding = ActivityQuizBinding.inflate(getLayoutInflater());&#10;        setContentView(binding.getRoot());&#10;        &#10;        // Asegurar fondo blanco y sin bordes&#10;        getWindow().setBackgroundDrawableResource(android.R.color.white);&#10;        if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.LOLLIPOP) {&#10;            getWindow().getDecorView().setSystemUiVisibility(&#10;                android.view.View.SYSTEM_UI_FLAG_LAYOUT_STABLE&#10;            );&#10;        }&#10;&#10;        areaUi    = getIntent().getStringExtra(EXTRA_AREA);&#10;        subtemaUi = getIntent().getStringExtra(EXTRA_SUBTEMA);&#10;        nivel     = getIntent().getIntExtra(EXTRA_NIVEL, 1);&#10;&#10;        // Configurar header&#10;        binding.tvAreaSubtema.setText(&quot;Pregunta 1 de 5 • &quot; + (areaUi != null ? areaUi : &quot;&quot;));&#10;&#10;        binding.rvQuestions.setLayoutManager(new LinearLayoutManager(this));&#10;        adapter = new QuizQuestionsAdapter(new ArrayList&lt;&gt;(), areaUi);&#10;        binding.rvQuestions.setAdapter(adapter);&#10;&#10;        // Ocultar ProgressBar completamente desde el inicio - NO mostrar pantalla de carga&#10;        if (binding.progress != null) {&#10;            binding.progress.setVisibility(View.GONE);&#10;        }&#10;&#10;        // Configurar botón con color del área (igual que la barra de progreso)&#10;        int areaColor = obtenerColorArea(areaUi);&#10;        binding.btnEnviar.setBackgroundResource(R.drawable.bg_button_area_color);&#10;        binding.btnEnviar.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        binding.btnEnviar.setTextColor(Color.WHITE);&#10;        binding.btnEnviar.setText(&quot;Siguiente Pregunta&quot;);&#10;        binding.btnEnviar.setElevation(4f);&#10;        &#10;        binding.btnEnviar.setOnClickListener(v -&gt; siguientePregunta());&#10;&#10;        crearParadaYMostrar();&#10;    }&#10;&#10;    private void setLoading(boolean b) {&#10;        // NO mostrar pantalla de carga - mantener invisible siempre para mejor UX&#10;        if (binding.progress != null) {&#10;            binding.progress.setVisibility(View.GONE);&#10;        }&#10;        // El botón se mantiene habilitado para mejor experiencia&#10;        binding.btnEnviar.setEnabled(true);&#10;    }&#10;&#10;    /** Crea sesión y pinta preguntas (máximo 10). */&#10;    private void crearParadaYMostrar() {&#10;        setLoading(true);&#10;&#10;        final String areaApi    = MapeadorArea.toApiArea(areaUi);&#10;        final String subtemaApi = MapeadorArea.normalizeSubtema(subtemaUi);&#10;&#10;        ApiService api = RetrofitClient.getInstance(this).create(ApiService.class);&#10;        ParadaRequest req = new ParadaRequest(&#10;                areaApi != null ? areaApi : &quot;&quot;,&#10;                subtemaApi != null ? subtemaApi : &quot;&quot;,&#10;                Math.max(1, Math.min(5, nivel)),&#10;                true,&#10;                1&#10;        );&#10;&#10;        logIAEvent(&quot;Solicitando preguntas a la API de generación de IA/OpenAI&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;&#10;        api.crearParada(req).enqueue(new Callback&lt;ParadaResponse&gt;() {&#10;            @Override public void onResponse(Call&lt;ParadaResponse&gt; call, Response&lt;ParadaResponse&gt; resp) {&#10;                setLoading(false);&#10;&#10;                if (!resp.isSuccessful()) {&#10;                    Toast.makeText(QuizActivity.this,&#10;                            &quot;No se pudo crear la sesión (HTTP &quot; + resp.code() + &quot;)&quot;,&#10;                            Toast.LENGTH_LONG).show();&#10;                    logIAEvent(&quot;Fallo al solicitar preguntas a la API (HTTP &quot; + resp.code() + &quot;)&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                    finish();&#10;                    return;&#10;                }&#10;&#10;                ParadaResponse pr = resp.body();&#10;                if (pr == null) {&#10;                    Toast.makeText(QuizActivity.this,&#10;                            &quot;Servidor respondió &quot; + resp.code() + &quot; sin cuerpo JSON.&quot;,&#10;                            Toast.LENGTH_LONG).show();&#10;                    logIAEvent(&quot;Respuesta sin cuerpo JSON de la API&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                    finish();&#10;                    return;&#10;                }&#10;&#10;                if (pr.sesion != null) idSesion = pr.sesion.idSesion;&#10;&#10;                ArrayList&lt;ApiQuestion&gt; apiQs = new ArrayList&lt;&gt;();&#10;                if (pr.preguntas != null) apiQs.addAll(pr.preguntas);&#10;                if (pr.preguntasPorSubtema != null) apiQs.addAll(pr.preguntasPorSubtema);&#10;                if (pr.sesion != null) {&#10;                    if (pr.sesion.preguntas != null) apiQs.addAll(pr.sesion.preguntas);&#10;                    if (pr.sesion.preguntasPorSubtema != null) apiQs.addAll(pr.sesion.preguntasPorSubtema);&#10;                }&#10;&#10;                // Log para saber si las preguntas son de IA o banco local&#10;                if (!apiQs.isEmpty()) {&#10;                    boolean esIA = apiQs.get(0).getIdPregunta() == null;&#10;                    if (esIA) {&#10;                        logIAEvent(&quot;✅ Preguntas generadas por IA (OpenAI)&quot;, idSesion, areaApi, subtemaApi, nivel, apiQs.size());&#10;                    } else {&#10;                        logIAEvent(&quot; Preguntas obtenidas del banco local&quot;, idSesion, areaApi, subtemaApi, nivel, apiQs.size());&#10;                    }&#10;                } else {&#10;                    logIAEvent(&quot;⚠️ No se recibieron preguntas de la API&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                }&#10;&#10;                ArrayList&lt;Question&gt; preguntas = ApiQuestionMapper.toAppList(apiQs);&#10;                if (preguntas.size() &gt; 10) preguntas = new ArrayList&lt;&gt;(preguntas.subList(0, 10));&#10;                if (preguntas.isEmpty()) {&#10;                    Toast.makeText(QuizActivity.this, &quot;No hay preguntas para este subtema.&quot;, Toast.LENGTH_LONG).show();&#10;                    logIAEvent(&quot;No hay preguntas para este subtema&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                    finish();&#10;                    return;&#10;                }&#10;&#10;                // Guardar todas las preguntas&#10;                allQuestions = preguntas;&#10;                currentQuestionIndex = 0;&#10;                todasLasRespuestas = new ArrayList&lt;&gt;();&#10;                // Inicializar lista de respuestas con nulls&#10;                for (int i = 0; i &lt; preguntas.size(); i++) {&#10;                    todasLasRespuestas.add(null);&#10;                }&#10;                &#10;                // Mostrar la primera pregunta&#10;                mostrarPreguntaActual();&#10;            }&#10;&#10;            @Override public void onFailure(Call&lt;ParadaResponse&gt; call, Throwable t) {&#10;                setLoading(false);&#10;                Toast.makeText(QuizActivity.this, &quot;Error de red: &quot; + t.getMessage(), Toast.LENGTH_LONG).show();&#10;                finish();&#10;            }&#10;        });&#10;    }&#10;&#10;    /** Muestra la pregunta actual */&#10;    private void mostrarPreguntaActual() {&#10;        if (allQuestions.isEmpty() || currentQuestionIndex &gt;= allQuestions.size()) {&#10;            Toast.makeText(this, &quot;No hay preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Crear lista con solo la pregunta actual para el adapter&#10;        List&lt;Question&gt; preguntaActual = new ArrayList&lt;&gt;();&#10;        preguntaActual.add(allQuestions.get(currentQuestionIndex));&#10;        &#10;        // Obtener la respuesta guardada para esta pregunta (si existe)&#10;        String respuestaGuardada = todasLasRespuestas.get(currentQuestionIndex);&#10;        &#10;        // Crear adapter con la pregunta actual, respuesta guardada y número de pregunta&#10;        adapter = new QuizQuestionsAdapter(preguntaActual, areaUi, respuestaGuardada, currentQuestionIndex + 1);&#10;        binding.rvQuestions.setAdapter(adapter);&#10;        &#10;        // Actualizar header&#10;        binding.tvAreaSubtema.setText(&quot;Pregunta &quot; + (currentQuestionIndex + 1) + &quot; de &quot; + allQuestions.size() + &quot; • &quot; + (areaUi != null ? areaUi : &quot;&quot;));&#10;        &#10;        // Actualizar texto y color del botón (usar color del área)&#10;        int areaColor = obtenerColorArea(areaUi);&#10;        binding.btnEnviar.setBackgroundResource(R.drawable.bg_button_area_color);&#10;        binding.btnEnviar.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        if (currentQuestionIndex == allQuestions.size() - 1) {&#10;            binding.btnEnviar.setText(&quot;Finalizar&quot;);&#10;        } else {&#10;            binding.btnEnviar.setText(&quot;Siguiente Pregunta&quot;);&#10;        }&#10;    }&#10;    &#10;    /** Avanza a la siguiente pregunta o envía todas las respuestas si es la última */&#10;    private void siguientePregunta() {&#10;        if (adapter.getItemCount() == 0) {&#10;            Toast.makeText(this, &quot;No hay preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Verificar que la pregunta actual tenga respuesta&#10;        List&lt;String&gt; marcadas = adapter.getMarcadas();&#10;        if (marcadas.isEmpty() || marcadas.get(0) == null) {&#10;            Toast.makeText(this, &quot;Por favor selecciona una respuesta.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Guardar la respuesta de la pregunta actual&#10;        String respuestaActual = marcadas.get(0);&#10;        todasLasRespuestas.set(currentQuestionIndex, respuestaActual);&#10;        &#10;        // Si es la última pregunta, enviar todas las respuestas&#10;        if (currentQuestionIndex == allQuestions.size() - 1) {&#10;            enviarTodasLasRespuestas();&#10;        } else {&#10;            // Avanzar a la siguiente pregunta&#10;            currentQuestionIndex++;&#10;            mostrarPreguntaActual();&#10;        }&#10;    }&#10;    &#10;    /** Envía todas las respuestas: intenta NUEVO y si falla con &quot;cannot extract elements from an object&quot;, reintenta LEGACY. */&#10;    private void enviarTodasLasRespuestas() {&#10;        if (allQuestions.isEmpty()) {&#10;            Toast.makeText(this, &quot;No hay preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Asegurar que la última respuesta está guardada&#10;        List&lt;String&gt; marcadasActual = adapter.getMarcadas();&#10;        if (!marcadasActual.isEmpty() &amp;&amp; marcadasActual.get(0) != null) {&#10;            todasLasRespuestas.set(currentQuestionIndex, marcadasActual.get(0));&#10;        }&#10;        &#10;        // Verificar que todas las preguntas tengan respuesta&#10;        for (int i = 0; i &lt; todasLasRespuestas.size(); i++) {&#10;            if (todasLasRespuestas.get(i) == null) {&#10;                Toast.makeText(this, &quot;Por favor responde todas las preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;                // Volver a la pregunta sin respuesta&#10;                currentQuestionIndex = i;&#10;                mostrarPreguntaActual();&#10;                return;&#10;            }&#10;        }&#10;        &#10;        if (idSesion == null) {&#10;            Toast.makeText(this, &quot;No hay sesión activa.&quot;, Toast.LENGTH_LONG).show();&#10;            return;&#10;        }&#10;&#10;        // Construir lista de respuestas para enviar&#10;        List&lt;CerrarRequest.Respuesta&gt; rs = new ArrayList&lt;&gt;();&#10;        for (int i = 0; i &lt; todasLasRespuestas.size(); i++) {&#10;            String respuesta = todasLasRespuestas.get(i);&#10;            if (respuesta != null) {&#10;                // Obtener id_pregunta de la pregunta correspondiente&#10;                Integer idPregunta = null;&#10;                if (i &lt; allQuestions.size() &amp;&amp; allQuestions.get(i).id_pregunta != null) {&#10;                    try {&#10;                        idPregunta = Integer.parseInt(allQuestions.get(i).id_pregunta);&#10;                    } catch (NumberFormatException e) {&#10;                        // id_pregunta es null o no es numérico, se mantiene como null&#10;                    }&#10;                }&#10;                rs.add(new CerrarRequest.Respuesta(i + 1, idPregunta, respuesta));&#10;            }&#10;        }&#10;&#10;        setLoading(true);&#10;        ApiService api = RetrofitClient.getInstance(this).create(ApiService.class);&#10;&#10;        // Primer intento: formato NUEVO&#10;        api.cerrarSesion(new CerrarRequest(idSesion, rs)).enqueue(new Callback&lt;CerrarResponse&gt;() {&#10;            @Override public void onResponse(Call&lt;CerrarResponse&gt; call, Response&lt;CerrarResponse&gt; response) {&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null) {&#10;                    onCierreOk(response.body());&#10;                    return;&#10;                }&#10;&#10;                // ¿Mensaje típico del server legacy?&#10;                String err = readErr(response.errorBody());&#10;                boolean esLegacy = response.code() == 400 &amp;&amp;&#10;                        err != null &amp;&amp; err.contains(&quot;cannot extract elements from an object&quot;);&#10;&#10;                if (esLegacy) {&#10;                    // Reintento: LEGACY&#10;                    Map&lt;String, Object&gt; compat = new HashMap&lt;&gt;();&#10;                    compat.put(&quot;id_sesion&quot;, idSesion);&#10;                    List&lt;List&lt;Object&gt;&gt; legacyRs = new ArrayList&lt;&gt;();&#10;                    for (CerrarRequest.Respuesta r : rs) {&#10;                        List&lt;Object&gt; par = new ArrayList&lt;&gt;();&#10;                        par.add(r.opcion);&#10;                        par.add(r.orden);&#10;                        legacyRs.add(par);&#10;                    }&#10;                    compat.put(&quot;respuestas&quot;, legacyRs);&#10;&#10;                    api.cerrarSesionCompat(compat).enqueue(new Callback&lt;CerrarResponse&gt;() {&#10;                        @Override public void onResponse(Call&lt;CerrarResponse&gt; call2, Response&lt;CerrarResponse&gt; resp2) {&#10;                            setLoading(false);&#10;                            if (resp2.isSuccessful() &amp;&amp; resp2.body() != null) {&#10;                                onCierreOk(resp2.body());&#10;                            } else {&#10;                                Toast.makeText(QuizActivity.this,&#10;                                        &quot;No se pudo cerrar (compat) HTTP &quot; + resp2.code(),&#10;                                        Toast.LENGTH_LONG).show();&#10;                            }&#10;                        }&#10;                        @Override public void onFailure(Call&lt;CerrarResponse&gt; call2, Throwable t) {&#10;                            setLoading(false);&#10;                            Toast.makeText(QuizActivity.this, &quot;Fallo compat: &quot; + t.getMessage(), Toast.LENGTH_LONG).show();&#10;                        }&#10;                    });&#10;                } else {&#10;                    setLoading(false);&#10;                    Toast.makeText(QuizActivity.this,&#10;                            &quot;No se pudo cerrar la sesión (HTTP &quot; + response.code() + &quot;).&quot;,&#10;                            Toast.LENGTH_LONG).show();&#10;                }&#10;            }&#10;&#10;            @Override public void onFailure(Call&lt;CerrarResponse&gt; call, Throwable t) {&#10;                setLoading(false);&#10;                Toast.makeText(QuizActivity.this, &quot;Fallo al cerrar: &quot; + t.getMessage(), Toast.LENGTH_LONG).show();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void onCierreOk(CerrarResponse r) {&#10;        setLoading(false);&#10;        Integer puntaje = r.puntaje;&#10;        int correctas = r.correctas != null ? r.correctas : 0;&#10;        int totalPreguntas = allQuestions.size();&#10;&#10;        // CRÍTICO: Usar TokenManager como fuente única de verdad&#10;        int userIdInt = com.example.zavira_movil.local.TokenManager.getUserId(this);&#10;        if (userIdInt &lt;= 0) {&#10;            android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: userId inválido al cerrar sesión&quot;);&#10;            finish();&#10;            return;&#10;        }&#10;        String userId = String.valueOf(userIdInt);&#10;        &#10;        // Nivel 1: Pasa con 4 o 5 correctas (sin límite de intentos)&#10;        if (nivel == 1) {&#10;            if (correctas &gt;= 4) {&#10;                // Pasa al nivel 2&#10;                ProgressLockManager.unlockNextAndSync(this, userId, areaUi, nivel);&#10;                // Reiniciar vidas para el nivel 2&#10;                LivesManager.resetLivesForNextLevelAndSync(this, userId, areaUi, 2);&#10;                &#10;                // Mostrar diálogo explicativo del sistema de vidas (solo la primera vez)&#10;                mostrarDialogoExplicacionVidas(areaUi);&#10;                return;&#10;            } else {&#10;                // No pasa, pero puede seguir intentando (sin límite)&#10;                Toast.makeText(this,&#10;                        &quot;Correctas: &quot; + correctas + &quot; | Puntaje: &quot; + (puntaje != null ? puntaje : 0) + &quot;%\n&quot; +&#10;                        &quot;Necesitas 4 o 5 correctas para pasar al siguiente nivel.&quot;,&#10;                        Toast.LENGTH_LONG).show();&#10;                finish();&#10;                return;&#10;            }&#10;        }&#10;&#10;        // Niveles 2+: Lógica con vidas&#10;        if (Boolean.TRUE.equals(r.aprueba)) {&#10;            // Si aprueba nivel 5, desbloquea Examen Final; si no, avanza normal&#10;            if (nivel &gt;= 5 &amp;&amp; (puntaje != null &amp;&amp; puntaje &gt;= 80)) {&#10;                ProgressLockManager.unlockFinalExamAndSync(this, userId, areaUi);&#10;                // Inicializar vidas para el examen final (nivel 6)&#10;                LivesManager.resetLivesAndSync(this, userId, areaUi, 6);&#10;                // Mostrar diálogo explicativo del examen final&#10;                mostrarDialogoExplicacionExamenFinal(areaUi);&#10;            } else {&#10;                ProgressLockManager.unlockNextAndSync(this, userId, areaUi, nivel);&#10;                // Reiniciar vidas para el siguiente nivel&#10;                LivesManager.resetLivesForNextLevelAndSync(this, userId, areaUi, nivel + 1);&#10;                mostrarDialogoExito(&quot;¡Felicitaciones! Pasaste al Nivel &quot; + (nivel + 1), areaUi);&#10;            }&#10;            return;&#10;        } else {&#10;            // No pasó - manejar vidas&#10;            // CRÍTICO: Solo consumir 1 vida por intento, no más&#10;            // IMPORTANTE: Si las vidas no están inicializadas, inicializarlas primero&#10;            int vidasRestantes = LivesManager.getLives(this, userId, areaUi, nivel);&#10;            android.util.Log.d(&quot;QuizActivity&quot;, &quot;Antes de consumir vida - vidasRestantes: &quot; + vidasRestantes + &quot;, nivel: &quot; + nivel);&#10;            &#10;            if (vidasRestantes == -1) {&#10;                // Si no están inicializadas, inicializar con MAX_LIVES&#10;                LivesManager.resetLives(this, userId, areaUi, nivel);&#10;                vidasRestantes = LivesManager.getLives(this, userId, areaUi, nivel);&#10;                android.util.Log.d(&quot;QuizActivity&quot;, &quot;Vidas inicializadas: &quot; + vidasRestantes);&#10;            }&#10;            &#10;            // CRÍTICO: Solo consumir 1 vida - el backend calculará las vidas correctamente al cerrar la sesión&#10;            // NO sincronizar vidas aquí porque el backend ya las calculará correctamente&#10;            boolean tieneVidas = LivesManager.consumeLife(this, userId, areaUi, nivel);&#10;            int nuevasVidas = LivesManager.getLives(this, userId, areaUi, nivel);&#10;            android.util.Log.d(&quot;QuizActivity&quot;, &quot;Después de consumir vida - tieneVidas: &quot; + tieneVidas + &quot;, nuevasVidas: &quot; + nuevasVidas);&#10;            &#10;            // Sincronizar vidas con backend DESPUÉS de consumir (solo para informar, el backend calculará correctamente)&#10;            // Solo sincronizar si el nivel es mayor a 1 (nivel 1 no tiene vidas)&#10;            if (nivel &gt; 1) {&#10;                com.example.zavira_movil.sincronizacion.ProgresoSincronizador.getInstance()&#10;                    .actualizarVidasEnBackend(this, userId, areaUi, nivel, nuevasVidas);&#10;            }&#10;            &#10;            if (tieneVidas) {&#10;                // Todavía tiene vidas - mostrar diálogo&#10;                mostrarDialogoVidas(correctas, totalPreguntas, nuevasVidas, false);&#10;            } else {&#10;                // CRÍTICO: Se acabaron las vidas - retroceder INMEDIATAMENTE y bloquear el nivel&#10;                android.util.Log.d(&quot;QuizActivity&quot;, &quot;Vidas agotadas en nivel &quot; + nivel + &quot; - retrocediendo INMEDIATAMENTE&quot;);&#10;                &#10;                // Retroceder INMEDIATAMENTE al nivel anterior (esto bloquea el nivel actual)&#10;                ProgressLockManager.retrocederPorFalloAndSync(this, userId, areaUi, nivel);&#10;                &#10;                // Obtener el nivel retrocedido (debe ser nivel - 1)&#10;                int nivelRetrocedido = ProgressLockManager.getUnlockedLevel(this, userId, areaUi);&#10;                android.util.Log.d(&quot;QuizActivity&quot;, &quot;Nivel retrocedido a: &quot; + nivelRetrocedido + &quot; (desde nivel &quot; + nivel + &quot;)&quot;);&#10;                &#10;                // Reiniciar vidas para el nivel retrocedido (3 vidas nuevas)&#10;                LivesManager.resetLivesAndSync(this, userId, areaUi, nivelRetrocedido);&#10;                &#10;                // Verificar que el nivel se bloqueó correctamente&#10;                int nivelVerificado = ProgressLockManager.getUnlockedLevel(this, userId, areaUi);&#10;                if (nivelVerificado != nivelRetrocedido) {&#10;                    android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: El nivel no se bloqueó correctamente. Esperado: &quot; + nivelRetrocedido + &quot;, Obtenido: &quot; + nivelVerificado);&#10;                } else {&#10;                    android.util.Log.d(&quot;QuizActivity&quot;, &quot;✓ Nivel bloqueado correctamente. Nivel actual desbloqueado: &quot; + nivelVerificado);&#10;                }&#10;                &#10;                mostrarDialogoVidas(correctas, totalPreguntas, 0, true);&#10;            }&#10;        }&#10;        &#10;        // CRÍTICO: Sincronizar desde el backend DESPUÉS de manejar vidas para asegurar consistencia&#10;        // El backend ya calculó las vidas correctamente al cerrar la sesión&#10;        // IMPORTANTE: Sincronizar inmediatamente para que el retroceso se refleje correctamente&#10;        if (userIdInt &gt; 0) {&#10;            // Sincronizar inmediatamente para que el retroceso se refleje correctamente&#10;            com.example.zavira_movil.sincronizacion.ProgresoSincronizador.getInstance()&#10;                .sincronizarDesdeBackend(QuizActivity.this, String.valueOf(userIdInt));&#10;        }&#10;    }&#10;    &#10;    private void mostrarDialogoVidas(int correctas, int totalPreguntas, int vidasRestantes, boolean sinVidas) {&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_vidas_nivel, null);&#10;        &#10;        // Obtener color del área&#10;        int areaColor = obtenerColorArea(areaUi);&#10;        &#10;        // Configurar color de la tarjeta del diálogo&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            // Usar un color muy claro del área como fondo de la tarjeta&#10;            int colorClaro = Color.argb(20, Color.red(areaColor), Color.green(areaColor), Color.blue(areaColor));&#10;            cardDialog.setCardBackgroundColor(colorClaro);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(2);&#10;        }&#10;        &#10;        // Configurar elementos del diálogo&#10;        ImageView ivIcono = dialogView.findViewById(R.id.ivIconoVida);&#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvSubtitulo = dialogView.findViewById(R.id.tvSubtitulo);&#10;        LinearLayout llCorazones = dialogView.findViewById(R.id.llCorazones);&#10;        TextView tvVidasRestantes = dialogView.findViewById(R.id.tvVidasRestantes);&#10;        TextView tvRegeneracion = dialogView.findViewById(R.id.tvRegeneracion);&#10;        TextView tvMensajeFinal = dialogView.findViewById(R.id.tvMensajeFinal);&#10;        MaterialButton btnUsarVida = dialogView.findViewById(R.id.btnUsarVida);&#10;        MaterialButton btnCancelar = dialogView.findViewById(R.id.btnCancelar);&#10;        &#10;        // Configurar icono y título según el ejemplo&#10;        if (sinVidas) {&#10;            ivIcono.setImageResource(android.R.drawable.ic_menu_revert);&#10;            ivIcono.setColorFilter(Color.parseColor(&quot;#E53935&quot;));&#10;            tvTitulo.setText(&quot;Sin Vidas Disponibles&quot;);&#10;            tvTitulo.setTextColor(Color.parseColor(&quot;#1F2937&quot;)); // Título oscuro para mejor legibilidad&#10;        } else {&#10;            ivIcono.setImageResource(android.R.drawable.ic_menu_revert);&#10;            ivIcono.setColorFilter(areaColor);&#10;            tvTitulo.setText(&quot;Necesitas Practicar Más&quot;);&#10;            tvTitulo.setTextColor(Color.parseColor(&quot;#1F2937&quot;)); // Título oscuro para mejor legibilidad&#10;        }&#10;        &#10;        // Configurar subtítulo&#10;        tvSubtitulo.setText(&quot;Obtuviste &quot; + correctas + &quot; de &quot; + totalPreguntas + &quot; respuestas correctas&quot;);&#10;        &#10;        // Configurar corazones - diseño mejorado según ejemplo (más pequeños)&#10;        llCorazones.removeAllViews();&#10;        for (int i = 0; i &lt; 3; i++) {&#10;            ImageView ivCorazon = new ImageView(this);&#10;            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(&#10;                    dp(28), dp(28)&#10;            );&#10;            params.setMargins(dp(4), 0, dp(4), 0);&#10;            ivCorazon.setLayoutParams(params);&#10;            ivCorazon.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;            &#10;            if (i &lt; vidasRestantes) {&#10;                // Corazón lleno del color del área&#10;                ivCorazon.setImageResource(R.drawable.ic_heart_filled);&#10;                ivCorazon.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;            } else {&#10;                // Corazón vacío&#10;                ivCorazon.setImageResource(R.drawable.ic_heart_empty);&#10;                ivCorazon.setColorFilter(Color.parseColor(&quot;#CCCCCC&quot;), android.graphics.PorterDuff.Mode.SRC_IN);&#10;            }&#10;            llCorazones.addView(ivCorazon);&#10;        }&#10;        &#10;        // Configurar vidas restantes&#10;        if (sinVidas) {&#10;            tvVidasRestantes.setVisibility(View.GONE);&#10;            tvRegeneracion.setVisibility(View.VISIBLE);&#10;            tvRegeneracion.setTextColor(areaColor); // Color del área para el mensaje de regeneración&#10;            tvMensajeFinal.setVisibility(View.VISIBLE);&#10;            tvMensajeFinal.setTextColor(areaColor); // Color del área para el mensaje final&#10;            btnUsarVida.setVisibility(View.GONE);&#10;        } else {&#10;            tvVidasRestantes.setText(&quot;Te quedan &quot; + vidasRestantes + &quot; vidas&quot;);&#10;            tvVidasRestantes.setTextColor(areaColor); // Color del área para vidas restantes&#10;            tvRegeneracion.setVisibility(View.GONE);&#10;            tvMensajeFinal.setVisibility(View.GONE);&#10;            btnUsarVida.setText(&quot;Usar 1 Vida (&quot; + vidasRestantes + &quot; restantes)&quot;);&#10;            btnUsarVida.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;            btnUsarVida.setIconResource(android.R.drawable.ic_menu_revert);&#10;        }&#10;        &#10;        // Crear y mostrar diálogo&#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        // Configurar ventana del diálogo: overlay oscuro para fondo y transparente para el diálogo&#10;        if (dialog.getWindow() != null) {&#10;            // Fondo oscuro semi-transparente para el overlay&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            // Asegurar que el diálogo tenga el tamaño correcto&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        btnUsarVida.setOnClickListener(v -&gt; {&#10;            dialog.dismiss();&#10;            // Reiniciar el nivel para volver a intentar&#10;            setResult(RESULT_OK); // Notificar que hubo cambios para actualizar la UI&#10;            finish();&#10;        });&#10;        &#10;        btnCancelar.setOnClickListener(v -&gt; {&#10;            dialog.dismiss();&#10;            setResult(RESULT_OK); // Notificar que hubo cambios para actualizar la UI&#10;            finish();&#10;        });&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private void mostrarDialogoExplicacionVidas(String area) {&#10;        // Verificar si ya vio el tutorial&#10;        int userIdInt = com.example.zavira_movil.local.TokenManager.getUserId(this);&#10;        if (userIdInt &lt;= 0) {&#10;            android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: userId inválido en mostrarDialogoExplicacionVidas&quot;);&#10;            return;&#10;        }&#10;        int userId = userIdInt;&#10;        String prefsKey = &quot;vidas_tutorial_visto_&quot; + userId + &quot;_&quot; + area;&#10;        boolean yaVisto = getSharedPreferences(&quot;vidas_tutorial&quot;, MODE_PRIVATE).getBoolean(prefsKey, false);&#10;        &#10;        if (yaVisto) {&#10;            // Si ya vio el tutorial, solo mostrar toast y cerrar&#10;            Toast.makeText(this, &quot;¡Felicitaciones! Pasaste al Nivel 2&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;            return;&#10;        }&#10;        &#10;        // Mostrar diálogo explicativo&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_explicacion_vidas, null);&#10;        int areaColor = obtenerColorArea(area);&#10;        &#10;        // Configurar color de la tarjeta del diálogo - diseño más sutil&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            // Fondo blanco con borde sutil del color del área&#10;            cardDialog.setCardBackgroundColor(Color.WHITE);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(3);&#10;        }&#10;        &#10;        ImageView ivIcono = dialogView.findViewById(R.id.ivIconoVida);&#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvMensaje = dialogView.findViewById(R.id.tvMensaje);&#10;        LinearLayout llCorazones = dialogView.findViewById(R.id.llCorazones);&#10;        MaterialButton btnEntendido = dialogView.findViewById(R.id.btnEntendido);&#10;        &#10;        // Configurar icono con color del área (ya está dentro del contenedor circular)&#10;        if (ivIcono != null) {&#10;            ivIcono.setImageResource(R.drawable.ic_heart_filled);&#10;            ivIcono.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;        }&#10;        &#10;        // Configurar corazones (3 llenos) - tamaño más pequeño y elegante&#10;        llCorazones.removeAllViews();&#10;        for (int i = 0; i &lt; 3; i++) {&#10;            ImageView ivCorazon = new ImageView(this);&#10;            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(&#10;                    dp(28), dp(28)&#10;            );&#10;            params.setMargins(dp(4), 0, dp(4), 0);&#10;            ivCorazon.setLayoutParams(params);&#10;            ivCorazon.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;            ivCorazon.setImageResource(R.drawable.ic_heart_filled);&#10;            ivCorazon.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;            llCorazones.addView(ivCorazon);&#10;        }&#10;        &#10;        // Configurar botón con color del área&#10;        btnEntendido.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        &#10;        // Crear y mostrar diálogo&#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        // Configurar ventana del diálogo: overlay oscuro para fondo y transparente para el diálogo&#10;        if (dialog.getWindow() != null) {&#10;            // Fondo oscuro semi-transparente para el overlay&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            // Asegurar que el diálogo tenga el tamaño correcto&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        btnEntendido.setOnClickListener(v -&gt; {&#10;            // Marcar como visto&#10;            getSharedPreferences(&quot;vidas_tutorial&quot;, MODE_PRIVATE)&#10;                    .edit()&#10;                    .putBoolean(prefsKey, true)&#10;                    .apply();&#10;            &#10;            dialog.dismiss();&#10;            Toast.makeText(this, &quot;¡Felicitaciones! Pasaste al Nivel 2&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;        });&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private void mostrarDialogoExito(String mensaje, String area) {&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_exito_nivel, null);&#10;        int areaColor = obtenerColorArea(area);&#10;        &#10;        // Configurar color de la tarjeta del diálogo&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            cardDialog.setCardBackgroundColor(Color.WHITE);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(3);&#10;        }&#10;        &#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvMensaje = dialogView.findViewById(R.id.tvMensaje);&#10;        MaterialButton btnContinuar = dialogView.findViewById(R.id.btnContinuar);&#10;        &#10;        tvMensaje.setText(mensaje);&#10;        &#10;        // Configurar botón con color del área&#10;        btnContinuar.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        &#10;        // Crear y mostrar diálogo&#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        // Configurar ventana del diálogo: overlay oscuro para fondo y transparente para el diálogo&#10;        if (dialog.getWindow() != null) {&#10;            // Fondo oscuro semi-transparente para el overlay&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            // Asegurar que el diálogo tenga el tamaño correcto&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        btnContinuar.setOnClickListener(v -&gt; {&#10;            dialog.dismiss();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;        });&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private void mostrarDialogoExplicacionExamenFinal(String area) {&#10;        // Verificar si ya vio el tutorial&#10;        int userIdInt = com.example.zavira_movil.local.TokenManager.getUserId(this);&#10;        if (userIdInt &lt;= 0) {&#10;            android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: userId inválido en mostrarDialogoExplicacionExamenFinal&quot;);&#10;            return;&#10;        }&#10;        int userId = userIdInt;&#10;        String prefsKey = &quot;examen_final_tutorial_visto_&quot; + userId + &quot;_&quot; + area;&#10;        boolean yaVisto = getSharedPreferences(&quot;examen_final_tutorial&quot;, MODE_PRIVATE).getBoolean(prefsKey, false);&#10;        &#10;        if (yaVisto) {&#10;            // Si ya vio el tutorial, solo mostrar toast y cerrar&#10;            Toast.makeText(this, &quot;¡Felicitaciones! Desbloqueaste el Examen Final&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;            return;&#10;        }&#10;        &#10;        // Mostrar diálogo explicativo&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_explicacion_vidas, null);&#10;        int areaColor = obtenerColorArea(area);&#10;        &#10;        // Configurar color de la tarjeta del diálogo&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            cardDialog.setCardBackgroundColor(Color.WHITE);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(3);&#10;        }&#10;        &#10;        ImageView ivIcono = dialogView.findViewById(R.id.ivIconoVida);&#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvMensaje = dialogView.findViewById(R.id.tvMensaje);&#10;        LinearLayout llCorazones = dialogView.findViewById(R.id.llCorazones);&#10;        MaterialButton btnEntendido = dialogView.findViewById(R.id.btnEntendido);&#10;        &#10;        if (ivIcono != null) {&#10;            ivIcono.setImageResource(android.R.drawable.ic_menu_info_details);&#10;            ivIcono.setColorFilter(areaColor);&#10;        }&#10;        &#10;        tvTitulo.setText(&quot;¡Examen Final Desbloqueado!&quot;);&#10;        tvTitulo.setTextColor(Color.parseColor(&quot;#1F2937&quot;));&#10;        &#10;        tvMensaje.setText(&quot;¡Felicitaciones! Has desbloqueado el Examen Final de &quot; + area + &quot;.\n\n&quot; +&#10;                         &quot;El Examen Final consiste en 25 preguntas de esta área.\n\n&quot; +&#10;                         &quot;Para aprobar, necesitas responder correctamente 20 de las 25 preguntas.\n\n&quot; +&#10;                         &quot;Tendrás 3 intentos (vidas) para aprobar el examen. Si pierdes los 3 intentos, &quot; +&#10;                         &quot;podrás intentarlo nuevamente después de un tiempo.\n\n&quot; +&#10;                         &quot;Si apruebas, obtendrás una insignia por tu excelente desempeño.&quot;);&#10;        &#10;        // Configurar corazones (vidas)&#10;        llCorazones.removeAllViews();&#10;        for (int i = 0; i &lt; 3; i++) {&#10;            ImageView ivCorazon = new ImageView(this);&#10;            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(&#10;                    dp(28), dp(28)&#10;            );&#10;            params.setMargins(dp(4), 0, dp(4), 0);&#10;            ivCorazon.setLayoutParams(params);&#10;            ivCorazon.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;            ivCorazon.setImageResource(R.drawable.ic_heart_filled);&#10;            ivCorazon.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;            llCorazones.addView(ivCorazon);&#10;        }&#10;        &#10;        btnEntendido.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        btnEntendido.setOnClickListener(v -&gt; {&#10;            // Marcar tutorial como visto&#10;            getSharedPreferences(&quot;examen_final_tutorial&quot;, MODE_PRIVATE)&#10;                    .edit()&#10;                    .putBoolean(prefsKey, true)&#10;                    .apply();&#10;            &#10;            Toast.makeText(this, &quot;¡Felicitaciones! Desbloqueaste el Examen Final&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;        });&#10;        &#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        if (dialog.getWindow() != null) {&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private int obtenerColorArea(String area) {&#10;        if (area == null) return Color.parseColor(&quot;#B6B9C2&quot;);&#10;        String a = area.toLowerCase().trim();&#10;        &#10;        if (a.contains(&quot;matem&quot;)) return ContextCompat.getColor(this, R.color.area_matematicas);&#10;        if (a.contains(&quot;lengua&quot;) || a.contains(&quot;lectura&quot;) || a.contains(&quot;espa&quot;) || a.contains(&quot;critica&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_lenguaje);&#10;        if (a.contains(&quot;social&quot;) || a.contains(&quot;ciudad&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_sociales);&#10;        if (a.contains(&quot;cien&quot;) || a.contains(&quot;biolo&quot;) || a.contains(&quot;fis&quot;) || a.contains(&quot;quim&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ciencias);&#10;        if (a.contains(&quot;ingl&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ingles);&#10;        &#10;        return Color.parseColor(&quot;#B6B9C2&quot;);&#10;    }&#10;    &#10;    private int obtenerColorAreaSoft(String area) {&#10;        if (area == null) return Color.parseColor(&quot;#BA68C8&quot;);&#10;        String a = area.toLowerCase().trim();&#10;        &#10;        if (a.contains(&quot;matem&quot;)) return ContextCompat.getColor(this, R.color.area_matematicas_soft);&#10;        if (a.contains(&quot;lengua&quot;) || a.contains(&quot;lectura&quot;) || a.contains(&quot;espa&quot;) || a.contains(&quot;critica&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_lenguaje_soft);&#10;        if (a.contains(&quot;social&quot;) || a.contains(&quot;ciudad&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_sociales_soft);&#10;        if (a.contains(&quot;cien&quot;) || a.contains(&quot;biolo&quot;) || a.contains(&quot;fis&quot;) || a.contains(&quot;quim&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ciencias_soft);&#10;        if (a.contains(&quot;ingl&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ingles_soft);&#10;        &#10;        return Color.parseColor(&quot;#BA68C8&quot;);&#10;    }&#10;    &#10;    private int dp(int px) {&#10;        return (int) (px * getResources().getDisplayMetrics().density);&#10;    }&#10;&#10;    private static String readErr(ResponseBody eb) {&#10;        if (eb == null) return null;&#10;        try { return eb.string(); } catch (IOException ignored) { return null; }&#10;    }&#10;&#10;    /**&#10;     * Log utilitario para eventos de IA y preguntas.&#10;     */&#10;    private void logIAEvent(String mensaje, Integer idSesion, String area, String subtema, int nivel, int cantidadPreguntas) {&#10;        String logMsg = &quot;[IA_EVENT] &quot; + mensaje +&#10;                &quot; | idSesion=&quot; + (idSesion != null ? idSesion : &quot;null&quot;) +&#10;                &quot;, área=&quot; + (area != null ? area : &quot;null&quot;) +&#10;                &quot;, subtema=&quot; + (subtema != null ? subtema : &quot;null&quot;) +&#10;                &quot;, nivel=&quot; + nivel +&#10;                &quot;, preguntas=&quot; + cantidadPreguntas;&#10;        android.util.Log.d(&quot;QuizActivity&quot;, logMsg);&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.zavira_movil.niveleshome;&#10;&#10;import android.app.AlertDialog;&#10;import android.content.Context;&#10;import android.graphics.Color;&#10;import android.graphics.drawable.ColorDrawable;&#10;import android.os.Bundle;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.widget.ImageView;&#10;import android.widget.LinearLayout;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.core.content.ContextCompat;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;&#10;import com.example.zavira_movil.QuizQuestionsAdapter;&#10;import com.example.zavira_movil.R;&#10;import com.example.zavira_movil.databinding.ActivityQuizBinding;&#10;import com.example.zavira_movil.local.UserSession;&#10;import com.example.zavira_movil.model.Question;&#10;import com.example.zavira_movil.remote.ApiService;&#10;import com.example.zavira_movil.remote.RetrofitClient;&#10;import com.example.zavira_movil.niveleshome.ApiQuestion;&#10;import com.example.zavira_movil.niveleshome.ApiQuestionMapper;&#10;import com.example.zavira_movil.niveleshome.CerrarRequest;&#10;import com.example.zavira_movil.niveleshome.CerrarResponse;&#10;import com.example.zavira_movil.niveleshome.MapeadorArea;&#10;import com.example.zavira_movil.niveleshome.ParadaRequest;&#10;import com.example.zavira_movil.niveleshome.ParadaResponse;&#10;import com.google.android.material.button.MaterialButton;&#10;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.HashMap;&#10;import java.util.List;&#10;import java.util.Map;&#10;&#10;import okhttp3.ResponseBody;&#10;import retrofit2.Call;&#10;import retrofit2.Callback;&#10;import retrofit2.Response;&#10;&#10;/** Crea sesión, carga máx 10 preguntas, envía y desbloquea/retrocede según puntaje. */&#10;public class QuizActivity extends AppCompatActivity {&#10;&#10;    public static final String EXTRA_AREA    = &quot;extra_area&quot;;     // área visible UI&#10;    public static final String EXTRA_SUBTEMA = &quot;extra_subtema&quot;;  // subtema visible UI&#10;    public static final String EXTRA_NIVEL   = &quot;extra_nivel&quot;;    // 1..5&#10;&#10;    private ActivityQuizBinding binding;&#10;    private QuizQuestionsAdapter adapter;&#10;    private Integer idSesion;&#10;&#10;    private String areaUi, subtemaUi; // usamos UI para ProgressLockManager&#10;    private int nivel;&#10;    private int currentQuestionIndex = 0; // Índice de la pregunta actual&#10;    private List&lt;Question&gt; allQuestions = new ArrayList&lt;&gt;(); // Todas las preguntas&#10;    private List&lt;String&gt; todasLasRespuestas = new ArrayList&lt;&gt;(); // Respuestas guardadas mientras avanza&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        binding = ActivityQuizBinding.inflate(getLayoutInflater());&#10;        setContentView(binding.getRoot());&#10;        &#10;        // Asegurar fondo blanco y sin bordes&#10;        getWindow().setBackgroundDrawableResource(android.R.color.white);&#10;        if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.LOLLIPOP) {&#10;            getWindow().getDecorView().setSystemUiVisibility(&#10;                android.view.View.SYSTEM_UI_FLAG_LAYOUT_STABLE&#10;            );&#10;        }&#10;&#10;        areaUi    = getIntent().getStringExtra(EXTRA_AREA);&#10;        subtemaUi = getIntent().getStringExtra(EXTRA_SUBTEMA);&#10;        nivel     = getIntent().getIntExtra(EXTRA_NIVEL, 1);&#10;&#10;        // Configurar header&#10;        binding.tvAreaSubtema.setText(&quot;Pregunta 1 de 5 • &quot; + (areaUi != null ? areaUi : &quot;&quot;));&#10;&#10;        binding.rvQuestions.setLayoutManager(new LinearLayoutManager(this));&#10;        adapter = new QuizQuestionsAdapter(new ArrayList&lt;&gt;(), areaUi);&#10;        binding.rvQuestions.setAdapter(adapter);&#10;&#10;        // Ocultar ProgressBar completamente desde el inicio - NO mostrar pantalla de carga&#10;        if (binding.progress != null) {&#10;            binding.progress.setVisibility(View.GONE);&#10;        }&#10;&#10;        // Configurar botón con color del área (igual que la barra de progreso)&#10;        int areaColor = obtenerColorArea(areaUi);&#10;        binding.btnEnviar.setBackgroundResource(R.drawable.bg_button_area_color);&#10;        binding.btnEnviar.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        binding.btnEnviar.setTextColor(Color.WHITE);&#10;        binding.btnEnviar.setText(&quot;Siguiente Pregunta&quot;);&#10;        binding.btnEnviar.setElevation(4f);&#10;        &#10;        binding.btnEnviar.setOnClickListener(v -&gt; siguientePregunta());&#10;&#10;        crearParadaYMostrar();&#10;    }&#10;&#10;    private void setLoading(boolean b) {&#10;        // NO mostrar pantalla de carga - mantener invisible siempre para mejor UX&#10;        if (binding.progress != null) {&#10;            binding.progress.setVisibility(View.GONE);&#10;        }&#10;        // El botón se mantiene habilitado para mejor experiencia&#10;        binding.btnEnviar.setEnabled(true);&#10;    }&#10;&#10;    /** Crea sesión y pinta preguntas (máximo 10). */&#10;    private void crearParadaYMostrar() {&#10;        setLoading(true);&#10;&#10;        final String areaApi    = MapeadorArea.toApiArea(areaUi);&#10;        final String subtemaApi = MapeadorArea.normalizeSubtema(subtemaUi);&#10;&#10;        ApiService api = RetrofitClient.getInstance(this).create(ApiService.class);&#10;        ParadaRequest req = new ParadaRequest(&#10;                areaApi != null ? areaApi : &quot;&quot;,&#10;                subtemaApi != null ? subtemaApi : &quot;&quot;,&#10;                Math.max(1, Math.min(5, nivel)),&#10;                true,&#10;                1&#10;        );&#10;&#10;        logIAEvent(&quot;Solicitando preguntas a la API de generación de IA/OpenAI&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;&#10;        api.crearParada(req).enqueue(new Callback&lt;ParadaResponse&gt;() {&#10;            @Override public void onResponse(Call&lt;ParadaResponse&gt; call, Response&lt;ParadaResponse&gt; resp) {&#10;                setLoading(false);&#10;&#10;                if (!resp.isSuccessful()) {&#10;                    Toast.makeText(QuizActivity.this,&#10;                            &quot;No se pudo crear la sesión (HTTP &quot; + resp.code() + &quot;)&quot;,&#10;                            Toast.LENGTH_LONG).show();&#10;                    logIAEvent(&quot;Fallo al solicitar preguntas a la API (HTTP &quot; + resp.code() + &quot;)&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                    finish();&#10;                    return;&#10;                }&#10;&#10;                ParadaResponse pr = resp.body();&#10;                if (pr == null) {&#10;                    Toast.makeText(QuizActivity.this,&#10;                            &quot;Servidor respondió &quot; + resp.code() + &quot; sin cuerpo JSON.&quot;,&#10;                            Toast.LENGTH_LONG).show();&#10;                    logIAEvent(&quot;Respuesta sin cuerpo JSON de la API&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                    finish();&#10;                    return;&#10;                }&#10;&#10;                if (pr.sesion != null) idSesion = pr.sesion.idSesion;&#10;&#10;                ArrayList&lt;ApiQuestion&gt; apiQs = new ArrayList&lt;&gt;();&#10;                if (pr.preguntas != null) apiQs.addAll(pr.preguntas);&#10;                if (pr.preguntasPorSubtema != null) apiQs.addAll(pr.preguntasPorSubtema);&#10;                if (pr.sesion != null) {&#10;                    if (pr.sesion.preguntas != null) apiQs.addAll(pr.sesion.preguntas);&#10;                    if (pr.sesion.preguntasPorSubtema != null) apiQs.addAll(pr.sesion.preguntasPorSubtema);&#10;                }&#10;&#10;                // Log para saber si las preguntas son de IA o banco local&#10;                if (!apiQs.isEmpty()) {&#10;                    boolean esIA = apiQs.get(0).id_pregunta == null;&#10;                    if (esIA) {&#10;                        logIAEvent(&quot;✅ Preguntas generadas por IA (OpenAI)&quot;, idSesion, areaApi, subtemaApi, nivel, apiQs.size());&#10;                    } else {&#10;                        logIAEvent(&quot; Preguntas obtenidas del banco local&quot;, idSesion, areaApi, subtemaApi, nivel, apiQs.size());&#10;                    }&#10;                } else {&#10;                    logIAEvent(&quot;⚠️ No se recibieron preguntas de la API&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                }&#10;&#10;                ArrayList&lt;Question&gt; preguntas = ApiQuestionMapper.toAppList(apiQs);&#10;                if (preguntas.size() &gt; 10) preguntas = new ArrayList&lt;&gt;(preguntas.subList(0, 10));&#10;                if (preguntas.isEmpty()) {&#10;                    Toast.makeText(QuizActivity.this, &quot;No hay preguntas para este subtema.&quot;, Toast.LENGTH_LONG).show();&#10;                    logIAEvent(&quot;No hay preguntas para este subtema&quot;, idSesion, areaApi, subtemaApi, nivel, 0);&#10;                    finish();&#10;                    return;&#10;                }&#10;&#10;                // Guardar todas las preguntas&#10;                allQuestions = preguntas;&#10;                currentQuestionIndex = 0;&#10;                todasLasRespuestas = new ArrayList&lt;&gt;();&#10;                // Inicializar lista de respuestas con nulls&#10;                for (int i = 0; i &lt; preguntas.size(); i++) {&#10;                    todasLasRespuestas.add(null);&#10;                }&#10;                &#10;                // Mostrar la primera pregunta&#10;                mostrarPreguntaActual();&#10;            }&#10;&#10;            @Override public void onFailure(Call&lt;ParadaResponse&gt; call, Throwable t) {&#10;                setLoading(false);&#10;                Toast.makeText(QuizActivity.this, &quot;Error de red: &quot; + t.getMessage(), Toast.LENGTH_LONG).show();&#10;                finish();&#10;            }&#10;        });&#10;    }&#10;&#10;    /** Muestra la pregunta actual */&#10;    private void mostrarPreguntaActual() {&#10;        if (allQuestions.isEmpty() || currentQuestionIndex &gt;= allQuestions.size()) {&#10;            Toast.makeText(this, &quot;No hay preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Crear lista con solo la pregunta actual para el adapter&#10;        List&lt;Question&gt; preguntaActual = new ArrayList&lt;&gt;();&#10;        preguntaActual.add(allQuestions.get(currentQuestionIndex));&#10;        &#10;        // Obtener la respuesta guardada para esta pregunta (si existe)&#10;        String respuestaGuardada = todasLasRespuestas.get(currentQuestionIndex);&#10;        &#10;        // Crear adapter con la pregunta actual, respuesta guardada y número de pregunta&#10;        adapter = new QuizQuestionsAdapter(preguntaActual, areaUi, respuestaGuardada, currentQuestionIndex + 1);&#10;        binding.rvQuestions.setAdapter(adapter);&#10;        &#10;        // Actualizar header&#10;        binding.tvAreaSubtema.setText(&quot;Pregunta &quot; + (currentQuestionIndex + 1) + &quot; de &quot; + allQuestions.size() + &quot; • &quot; + (areaUi != null ? areaUi : &quot;&quot;));&#10;        &#10;        // Actualizar texto y color del botón (usar color del área)&#10;        int areaColor = obtenerColorArea(areaUi);&#10;        binding.btnEnviar.setBackgroundResource(R.drawable.bg_button_area_color);&#10;        binding.btnEnviar.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        if (currentQuestionIndex == allQuestions.size() - 1) {&#10;            binding.btnEnviar.setText(&quot;Finalizar&quot;);&#10;        } else {&#10;            binding.btnEnviar.setText(&quot;Siguiente Pregunta&quot;);&#10;        }&#10;    }&#10;    &#10;    /** Avanza a la siguiente pregunta o envía todas las respuestas si es la última */&#10;    private void siguientePregunta() {&#10;        if (adapter.getItemCount() == 0) {&#10;            Toast.makeText(this, &quot;No hay preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Verificar que la pregunta actual tenga respuesta&#10;        List&lt;String&gt; marcadas = adapter.getMarcadas();&#10;        if (marcadas.isEmpty() || marcadas.get(0) == null) {&#10;            Toast.makeText(this, &quot;Por favor selecciona una respuesta.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Guardar la respuesta de la pregunta actual&#10;        String respuestaActual = marcadas.get(0);&#10;        todasLasRespuestas.set(currentQuestionIndex, respuestaActual);&#10;        &#10;        // Si es la última pregunta, enviar todas las respuestas&#10;        if (currentQuestionIndex == allQuestions.size() - 1) {&#10;            enviarTodasLasRespuestas();&#10;        } else {&#10;            // Avanzar a la siguiente pregunta&#10;            currentQuestionIndex++;&#10;            mostrarPreguntaActual();&#10;        }&#10;    }&#10;    &#10;    /** Envía todas las respuestas: intenta NUEVO y si falla con &quot;cannot extract elements from an object&quot;, reintenta LEGACY. */&#10;    private void enviarTodasLasRespuestas() {&#10;        if (allQuestions.isEmpty()) {&#10;            Toast.makeText(this, &quot;No hay preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        &#10;        // Asegurar que la última respuesta está guardada&#10;        List&lt;String&gt; marcadasActual = adapter.getMarcadas();&#10;        if (!marcadasActual.isEmpty() &amp;&amp; marcadasActual.get(0) != null) {&#10;            todasLasRespuestas.set(currentQuestionIndex, marcadasActual.get(0));&#10;        }&#10;        &#10;        // Verificar que todas las preguntas tengan respuesta&#10;        for (int i = 0; i &lt; todasLasRespuestas.size(); i++) {&#10;            if (todasLasRespuestas.get(i) == null) {&#10;                Toast.makeText(this, &quot;Por favor responde todas las preguntas.&quot;, Toast.LENGTH_SHORT).show();&#10;                // Volver a la pregunta sin respuesta&#10;                currentQuestionIndex = i;&#10;                mostrarPreguntaActual();&#10;                return;&#10;            }&#10;        }&#10;        &#10;        if (idSesion == null) {&#10;            Toast.makeText(this, &quot;No hay sesión activa.&quot;, Toast.LENGTH_LONG).show();&#10;            return;&#10;        }&#10;&#10;        // Construir lista de respuestas para enviar&#10;        List&lt;CerrarRequest.Respuesta&gt; rs = new ArrayList&lt;&gt;();&#10;        for (int i = 0; i &lt; todasLasRespuestas.size(); i++) {&#10;            String respuesta = todasLasRespuestas.get(i);&#10;            if (respuesta != null) {&#10;                // Obtener id_pregunta de la pregunta correspondiente&#10;                Integer idPregunta = null;&#10;                if (i &lt; allQuestions.size() &amp;&amp; allQuestions.get(i).id_pregunta != null) {&#10;                    try {&#10;                        idPregunta = Integer.parseInt(allQuestions.get(i).id_pregunta);&#10;                    } catch (NumberFormatException e) {&#10;                        // id_pregunta es null o no es numérico, se mantiene como null&#10;                    }&#10;                }&#10;                rs.add(new CerrarRequest.Respuesta(i + 1, idPregunta, respuesta));&#10;            }&#10;        }&#10;&#10;        setLoading(true);&#10;        ApiService api = RetrofitClient.getInstance(this).create(ApiService.class);&#10;&#10;        // Primer intento: formato NUEVO&#10;        api.cerrarSesion(new CerrarRequest(idSesion, rs)).enqueue(new Callback&lt;CerrarResponse&gt;() {&#10;            @Override public void onResponse(Call&lt;CerrarResponse&gt; call, Response&lt;CerrarResponse&gt; response) {&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null) {&#10;                    onCierreOk(response.body());&#10;                    return;&#10;                }&#10;&#10;                // ¿Mensaje típico del server legacy?&#10;                String err = readErr(response.errorBody());&#10;                boolean esLegacy = response.code() == 400 &amp;&amp;&#10;                        err != null &amp;&amp; err.contains(&quot;cannot extract elements from an object&quot;);&#10;&#10;                if (esLegacy) {&#10;                    // Reintento: LEGACY&#10;                    Map&lt;String, Object&gt; compat = new HashMap&lt;&gt;();&#10;                    compat.put(&quot;id_sesion&quot;, idSesion);&#10;                    List&lt;List&lt;Object&gt;&gt; legacyRs = new ArrayList&lt;&gt;();&#10;                    for (CerrarRequest.Respuesta r : rs) {&#10;                        List&lt;Object&gt; par = new ArrayList&lt;&gt;();&#10;                        par.add(r.opcion);&#10;                        par.add(r.orden);&#10;                        legacyRs.add(par);&#10;                    }&#10;                    compat.put(&quot;respuestas&quot;, legacyRs);&#10;&#10;                    api.cerrarSesionCompat(compat).enqueue(new Callback&lt;CerrarResponse&gt;() {&#10;                        @Override public void onResponse(Call&lt;CerrarResponse&gt; call2, Response&lt;CerrarResponse&gt; resp2) {&#10;                            setLoading(false);&#10;                            if (resp2.isSuccessful() &amp;&amp; resp2.body() != null) {&#10;                                onCierreOk(resp2.body());&#10;                            } else {&#10;                                Toast.makeText(QuizActivity.this,&#10;                                        &quot;No se pudo cerrar (compat) HTTP &quot; + resp2.code(),&#10;                                        Toast.LENGTH_LONG).show();&#10;                            }&#10;                        }&#10;                        @Override public void onFailure(Call&lt;CerrarResponse&gt; call2, Throwable t) {&#10;                            setLoading(false);&#10;                            Toast.makeText(QuizActivity.this, &quot;Fallo compat: &quot; + t.getMessage(), Toast.LENGTH_LONG).show();&#10;                        }&#10;                    });&#10;                } else {&#10;                    setLoading(false);&#10;                    Toast.makeText(QuizActivity.this,&#10;                            &quot;No se pudo cerrar la sesión (HTTP &quot; + response.code() + &quot;).&quot;,&#10;                            Toast.LENGTH_LONG).show();&#10;                }&#10;            }&#10;&#10;            @Override public void onFailure(Call&lt;CerrarResponse&gt; call, Throwable t) {&#10;                setLoading(false);&#10;                Toast.makeText(QuizActivity.this, &quot;Fallo al cerrar: &quot; + t.getMessage(), Toast.LENGTH_LONG).show();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void onCierreOk(CerrarResponse r) {&#10;        setLoading(false);&#10;        Integer puntaje = r.puntaje;&#10;        int correctas = r.correctas != null ? r.correctas : 0;&#10;        int totalPreguntas = allQuestions.size();&#10;&#10;        // CRÍTICO: Usar TokenManager como fuente única de verdad&#10;        int userIdInt = com.example.zavira_movil.local.TokenManager.getUserId(this);&#10;        if (userIdInt &lt;= 0) {&#10;            android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: userId inválido al cerrar sesión&quot;);&#10;            finish();&#10;            return;&#10;        }&#10;        String userId = String.valueOf(userIdInt);&#10;        &#10;        // Nivel 1: Pasa con 4 o 5 correctas (sin límite de intentos)&#10;        if (nivel == 1) {&#10;            if (correctas &gt;= 4) {&#10;                // Pasa al nivel 2&#10;                ProgressLockManager.unlockNextAndSync(this, userId, areaUi, nivel);&#10;                // Reiniciar vidas para el nivel 2&#10;                LivesManager.resetLivesForNextLevelAndSync(this, userId, areaUi, 2);&#10;                &#10;                // Mostrar diálogo explicativo del sistema de vidas (solo la primera vez)&#10;                mostrarDialogoExplicacionVidas(areaUi);&#10;                return;&#10;            } else {&#10;                // No pasa, pero puede seguir intentando (sin límite)&#10;                Toast.makeText(this,&#10;                        &quot;Correctas: &quot; + correctas + &quot; | Puntaje: &quot; + (puntaje != null ? puntaje : 0) + &quot;%\n&quot; +&#10;                        &quot;Necesitas 4 o 5 correctas para pasar al siguiente nivel.&quot;,&#10;                        Toast.LENGTH_LONG).show();&#10;                finish();&#10;                return;&#10;            }&#10;        }&#10;&#10;        // Niveles 2+: Lógica con vidas&#10;        if (Boolean.TRUE.equals(r.aprueba)) {&#10;            // Si aprueba nivel 5, desbloquea Examen Final; si no, avanza normal&#10;            if (nivel &gt;= 5 &amp;&amp; (puntaje != null &amp;&amp; puntaje &gt;= 80)) {&#10;                ProgressLockManager.unlockFinalExamAndSync(this, userId, areaUi);&#10;                // Inicializar vidas para el examen final (nivel 6)&#10;                LivesManager.resetLivesAndSync(this, userId, areaUi, 6);&#10;                // Mostrar diálogo explicativo del examen final&#10;                mostrarDialogoExplicacionExamenFinal(areaUi);&#10;            } else {&#10;                ProgressLockManager.unlockNextAndSync(this, userId, areaUi, nivel);&#10;                // Reiniciar vidas para el siguiente nivel&#10;                LivesManager.resetLivesForNextLevelAndSync(this, userId, areaUi, nivel + 1);&#10;                mostrarDialogoExito(&quot;¡Felicitaciones! Pasaste al Nivel &quot; + (nivel + 1), areaUi);&#10;            }&#10;            return;&#10;        } else {&#10;            // No pasó - manejar vidas&#10;            // CRÍTICO: Solo consumir 1 vida por intento, no más&#10;            // IMPORTANTE: Si las vidas no están inicializadas, inicializarlas primero&#10;            int vidasRestantes = LivesManager.getLives(this, userId, areaUi, nivel);&#10;            android.util.Log.d(&quot;QuizActivity&quot;, &quot;Antes de consumir vida - vidasRestantes: &quot; + vidasRestantes + &quot;, nivel: &quot; + nivel);&#10;            &#10;            if (vidasRestantes == -1) {&#10;                // Si no están inicializadas, inicializar con MAX_LIVES&#10;                LivesManager.resetLives(this, userId, areaUi, nivel);&#10;                vidasRestantes = LivesManager.getLives(this, userId, areaUi, nivel);&#10;                android.util.Log.d(&quot;QuizActivity&quot;, &quot;Vidas inicializadas: &quot; + vidasRestantes);&#10;            }&#10;            &#10;            // CRÍTICO: Solo consumir 1 vida - el backend calculará las vidas correctamente al cerrar la sesión&#10;            // NO sincronizar vidas aquí porque el backend ya las calculará correctamente&#10;            boolean tieneVidas = LivesManager.consumeLife(this, userId, areaUi, nivel);&#10;            int nuevasVidas = LivesManager.getLives(this, userId, areaUi, nivel);&#10;            android.util.Log.d(&quot;QuizActivity&quot;, &quot;Después de consumir vida - tieneVidas: &quot; + tieneVidas + &quot;, nuevasVidas: &quot; + nuevasVidas);&#10;            &#10;            // Sincronizar vidas con backend DESPUÉS de consumir (solo para informar, el backend calculará correctamente)&#10;            // Solo sincronizar si el nivel es mayor a 1 (nivel 1 no tiene vidas)&#10;            if (nivel &gt; 1) {&#10;                com.example.zavira_movil.sincronizacion.ProgresoSincronizador.getInstance()&#10;                    .actualizarVidasEnBackend(this, userId, areaUi, nivel, nuevasVidas);&#10;            }&#10;            &#10;            if (tieneVidas) {&#10;                // Todavía tiene vidas - mostrar diálogo&#10;                mostrarDialogoVidas(correctas, totalPreguntas, nuevasVidas, false);&#10;            } else {&#10;                // CRÍTICO: Se acabaron las vidas - retroceder INMEDIATAMENTE y bloquear el nivel&#10;                android.util.Log.d(&quot;QuizActivity&quot;, &quot;Vidas agotadas en nivel &quot; + nivel + &quot; - retrocediendo INMEDIATAMENTE&quot;);&#10;                &#10;                // Retroceder INMEDIATAMENTE al nivel anterior (esto bloquea el nivel actual)&#10;                ProgressLockManager.retrocederPorFalloAndSync(this, userId, areaUi, nivel);&#10;                &#10;                // Obtener el nivel retrocedido (debe ser nivel - 1)&#10;                int nivelRetrocedido = ProgressLockManager.getUnlockedLevel(this, userId, areaUi);&#10;                android.util.Log.d(&quot;QuizActivity&quot;, &quot;Nivel retrocedido a: &quot; + nivelRetrocedido + &quot; (desde nivel &quot; + nivel + &quot;)&quot;);&#10;                &#10;                // Reiniciar vidas para el nivel retrocedido (3 vidas nuevas)&#10;                LivesManager.resetLivesAndSync(this, userId, areaUi, nivelRetrocedido);&#10;                &#10;                // Verificar que el nivel se bloqueó correctamente&#10;                int nivelVerificado = ProgressLockManager.getUnlockedLevel(this, userId, areaUi);&#10;                if (nivelVerificado != nivelRetrocedido) {&#10;                    android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: El nivel no se bloqueó correctamente. Esperado: &quot; + nivelRetrocedido + &quot;, Obtenido: &quot; + nivelVerificado);&#10;                } else {&#10;                    android.util.Log.d(&quot;QuizActivity&quot;, &quot;✓ Nivel bloqueado correctamente. Nivel actual desbloqueado: &quot; + nivelVerificado);&#10;                }&#10;                &#10;                mostrarDialogoVidas(correctas, totalPreguntas, 0, true);&#10;            }&#10;        }&#10;        &#10;        // CRÍTICO: Sincronizar desde el backend DESPUÉS de manejar vidas para asegurar consistencia&#10;        // El backend ya calculó las vidas correctamente al cerrar la sesión&#10;        // IMPORTANTE: Sincronizar inmediatamente para que el retroceso se refleje correctamente&#10;        if (userIdInt &gt; 0) {&#10;            // Sincronizar inmediatamente para que el retroceso se refleje correctamente&#10;            com.example.zavira_movil.sincronizacion.ProgresoSincronizador.getInstance()&#10;                .sincronizarDesdeBackend(QuizActivity.this, String.valueOf(userIdInt));&#10;        }&#10;    }&#10;    &#10;    private void mostrarDialogoVidas(int correctas, int totalPreguntas, int vidasRestantes, boolean sinVidas) {&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_vidas_nivel, null);&#10;        &#10;        // Obtener color del área&#10;        int areaColor = obtenerColorArea(areaUi);&#10;        &#10;        // Configurar color de la tarjeta del diálogo&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            // Usar un color muy claro del área como fondo de la tarjeta&#10;            int colorClaro = Color.argb(20, Color.red(areaColor), Color.green(areaColor), Color.blue(areaColor));&#10;            cardDialog.setCardBackgroundColor(colorClaro);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(2);&#10;        }&#10;        &#10;        // Configurar elementos del diálogo&#10;        ImageView ivIcono = dialogView.findViewById(R.id.ivIconoVida);&#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvSubtitulo = dialogView.findViewById(R.id.tvSubtitulo);&#10;        LinearLayout llCorazones = dialogView.findViewById(R.id.llCorazones);&#10;        TextView tvVidasRestantes = dialogView.findViewById(R.id.tvVidasRestantes);&#10;        TextView tvRegeneracion = dialogView.findViewById(R.id.tvRegeneracion);&#10;        TextView tvMensajeFinal = dialogView.findViewById(R.id.tvMensajeFinal);&#10;        MaterialButton btnUsarVida = dialogView.findViewById(R.id.btnUsarVida);&#10;        MaterialButton btnCancelar = dialogView.findViewById(R.id.btnCancelar);&#10;        &#10;        // Configurar icono y título según el ejemplo&#10;        if (sinVidas) {&#10;            ivIcono.setImageResource(android.R.drawable.ic_menu_revert);&#10;            ivIcono.setColorFilter(Color.parseColor(&quot;#E53935&quot;));&#10;            tvTitulo.setText(&quot;Sin Vidas Disponibles&quot;);&#10;            tvTitulo.setTextColor(Color.parseColor(&quot;#1F2937&quot;)); // Título oscuro para mejor legibilidad&#10;        } else {&#10;            ivIcono.setImageResource(android.R.drawable.ic_menu_revert);&#10;            ivIcono.setColorFilter(areaColor);&#10;            tvTitulo.setText(&quot;Necesitas Practicar Más&quot;);&#10;            tvTitulo.setTextColor(Color.parseColor(&quot;#1F2937&quot;)); // Título oscuro para mejor legibilidad&#10;        }&#10;        &#10;        // Configurar subtítulo&#10;        tvSubtitulo.setText(&quot;Obtuviste &quot; + correctas + &quot; de &quot; + totalPreguntas + &quot; respuestas correctas&quot;);&#10;        &#10;        // Configurar corazones - diseño mejorado según ejemplo (más pequeños)&#10;        llCorazones.removeAllViews();&#10;        for (int i = 0; i &lt; 3; i++) {&#10;            ImageView ivCorazon = new ImageView(this);&#10;            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(&#10;                    dp(28), dp(28)&#10;            );&#10;            params.setMargins(dp(4), 0, dp(4), 0);&#10;            ivCorazon.setLayoutParams(params);&#10;            ivCorazon.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;            &#10;            if (i &lt; vidasRestantes) {&#10;                // Corazón lleno del color del área&#10;                ivCorazon.setImageResource(R.drawable.ic_heart_filled);&#10;                ivCorazon.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;            } else {&#10;                // Corazón vacío&#10;                ivCorazon.setImageResource(R.drawable.ic_heart_empty);&#10;                ivCorazon.setColorFilter(Color.parseColor(&quot;#CCCCCC&quot;), android.graphics.PorterDuff.Mode.SRC_IN);&#10;            }&#10;            llCorazones.addView(ivCorazon);&#10;        }&#10;        &#10;        // Configurar vidas restantes&#10;        if (sinVidas) {&#10;            tvVidasRestantes.setVisibility(View.GONE);&#10;            tvRegeneracion.setVisibility(View.VISIBLE);&#10;            tvRegeneracion.setTextColor(areaColor); // Color del área para el mensaje de regeneración&#10;            tvMensajeFinal.setVisibility(View.VISIBLE);&#10;            tvMensajeFinal.setTextColor(areaColor); // Color del área para el mensaje final&#10;            btnUsarVida.setVisibility(View.GONE);&#10;        } else {&#10;            tvVidasRestantes.setText(&quot;Te quedan &quot; + vidasRestantes + &quot; vidas&quot;);&#10;            tvVidasRestantes.setTextColor(areaColor); // Color del área para vidas restantes&#10;            tvRegeneracion.setVisibility(View.GONE);&#10;            tvMensajeFinal.setVisibility(View.GONE);&#10;            btnUsarVida.setText(&quot;Usar 1 Vida (&quot; + vidasRestantes + &quot; restantes)&quot;);&#10;            btnUsarVida.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;            btnUsarVida.setIconResource(android.R.drawable.ic_menu_revert);&#10;        }&#10;        &#10;        // Crear y mostrar diálogo&#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        // Configurar ventana del diálogo: overlay oscuro para fondo y transparente para el diálogo&#10;        if (dialog.getWindow() != null) {&#10;            // Fondo oscuro semi-transparente para el overlay&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            // Asegurar que el diálogo tenga el tamaño correcto&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        btnUsarVida.setOnClickListener(v -&gt; {&#10;            dialog.dismiss();&#10;            // Reiniciar el nivel para volver a intentar&#10;            setResult(RESULT_OK); // Notificar que hubo cambios para actualizar la UI&#10;            finish();&#10;        });&#10;        &#10;        btnCancelar.setOnClickListener(v -&gt; {&#10;            dialog.dismiss();&#10;            setResult(RESULT_OK); // Notificar que hubo cambios para actualizar la UI&#10;            finish();&#10;        });&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private void mostrarDialogoExplicacionVidas(String area) {&#10;        // Verificar si ya vio el tutorial&#10;        int userIdInt = com.example.zavira_movil.local.TokenManager.getUserId(this);&#10;        if (userIdInt &lt;= 0) {&#10;            android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: userId inválido en mostrarDialogoExplicacionVidas&quot;);&#10;            return;&#10;        }&#10;        int userId = userIdInt;&#10;        String prefsKey = &quot;vidas_tutorial_visto_&quot; + userId + &quot;_&quot; + area;&#10;        boolean yaVisto = getSharedPreferences(&quot;vidas_tutorial&quot;, MODE_PRIVATE).getBoolean(prefsKey, false);&#10;        &#10;        if (yaVisto) {&#10;            // Si ya vio el tutorial, solo mostrar toast y cerrar&#10;            Toast.makeText(this, &quot;¡Felicitaciones! Pasaste al Nivel 2&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;            return;&#10;        }&#10;        &#10;        // Mostrar diálogo explicativo&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_explicacion_vidas, null);&#10;        int areaColor = obtenerColorArea(area);&#10;        &#10;        // Configurar color de la tarjeta del diálogo - diseño más sutil&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            // Fondo blanco con borde sutil del color del área&#10;            cardDialog.setCardBackgroundColor(Color.WHITE);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(3);&#10;        }&#10;        &#10;        ImageView ivIcono = dialogView.findViewById(R.id.ivIconoVida);&#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvMensaje = dialogView.findViewById(R.id.tvMensaje);&#10;        LinearLayout llCorazones = dialogView.findViewById(R.id.llCorazones);&#10;        MaterialButton btnEntendido = dialogView.findViewById(R.id.btnEntendido);&#10;        &#10;        // Configurar icono con color del área (ya está dentro del contenedor circular)&#10;        if (ivIcono != null) {&#10;            ivIcono.setImageResource(R.drawable.ic_heart_filled);&#10;            ivIcono.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;        }&#10;        &#10;        // Configurar corazones (3 llenos) - tamaño más pequeño y elegante&#10;        llCorazones.removeAllViews();&#10;        for (int i = 0; i &lt; 3; i++) {&#10;            ImageView ivCorazon = new ImageView(this);&#10;            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(&#10;                    dp(28), dp(28)&#10;            );&#10;            params.setMargins(dp(4), 0, dp(4), 0);&#10;            ivCorazon.setLayoutParams(params);&#10;            ivCorazon.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;            ivCorazon.setImageResource(R.drawable.ic_heart_filled);&#10;            ivCorazon.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;            llCorazones.addView(ivCorazon);&#10;        }&#10;        &#10;        // Configurar botón con color del área&#10;        btnEntendido.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        &#10;        // Crear y mostrar diálogo&#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        // Configurar ventana del diálogo: overlay oscuro para fondo y transparente para el diálogo&#10;        if (dialog.getWindow() != null) {&#10;            // Fondo oscuro semi-transparente para el overlay&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            // Asegurar que el diálogo tenga el tamaño correcto&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        btnEntendido.setOnClickListener(v -&gt; {&#10;            // Marcar como visto&#10;            getSharedPreferences(&quot;vidas_tutorial&quot;, MODE_PRIVATE)&#10;                    .edit()&#10;                    .putBoolean(prefsKey, true)&#10;                    .apply();&#10;            &#10;            dialog.dismiss();&#10;            Toast.makeText(this, &quot;¡Felicitaciones! Pasaste al Nivel 2&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;        });&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private void mostrarDialogoExito(String mensaje, String area) {&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_exito_nivel, null);&#10;        int areaColor = obtenerColorArea(area);&#10;        &#10;        // Configurar color de la tarjeta del diálogo&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            cardDialog.setCardBackgroundColor(Color.WHITE);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(3);&#10;        }&#10;        &#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvMensaje = dialogView.findViewById(R.id.tvMensaje);&#10;        MaterialButton btnContinuar = dialogView.findViewById(R.id.btnContinuar);&#10;        &#10;        tvMensaje.setText(mensaje);&#10;        &#10;        // Configurar botón con color del área&#10;        btnContinuar.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        &#10;        // Crear y mostrar diálogo&#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        // Configurar ventana del diálogo: overlay oscuro para fondo y transparente para el diálogo&#10;        if (dialog.getWindow() != null) {&#10;            // Fondo oscuro semi-transparente para el overlay&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            // Asegurar que el diálogo tenga el tamaño correcto&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        btnContinuar.setOnClickListener(v -&gt; {&#10;            dialog.dismiss();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;        });&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private void mostrarDialogoExplicacionExamenFinal(String area) {&#10;        // Verificar si ya vio el tutorial&#10;        int userIdInt = com.example.zavira_movil.local.TokenManager.getUserId(this);&#10;        if (userIdInt &lt;= 0) {&#10;            android.util.Log.e(&quot;QuizActivity&quot;, &quot;ERROR: userId inválido en mostrarDialogoExplicacionExamenFinal&quot;);&#10;            return;&#10;        }&#10;        int userId = userIdInt;&#10;        String prefsKey = &quot;examen_final_tutorial_visto_&quot; + userId + &quot;_&quot; + area;&#10;        boolean yaVisto = getSharedPreferences(&quot;examen_final_tutorial&quot;, MODE_PRIVATE).getBoolean(prefsKey, false);&#10;        &#10;        if (yaVisto) {&#10;            // Si ya vio el tutorial, solo mostrar toast y cerrar&#10;            Toast.makeText(this, &quot;¡Felicitaciones! Desbloqueaste el Examen Final&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;            return;&#10;        }&#10;        &#10;        // Mostrar diálogo explicativo&#10;        View dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_explicacion_vidas, null);&#10;        int areaColor = obtenerColorArea(area);&#10;        &#10;        // Configurar color de la tarjeta del diálogo&#10;        com.google.android.material.card.MaterialCardView cardDialog = dialogView.findViewById(R.id.cardDialog);&#10;        if (cardDialog != null) {&#10;            cardDialog.setCardBackgroundColor(Color.WHITE);&#10;            cardDialog.setStrokeColor(areaColor);&#10;            cardDialog.setStrokeWidth(3);&#10;        }&#10;        &#10;        ImageView ivIcono = dialogView.findViewById(R.id.ivIconoVida);&#10;        TextView tvTitulo = dialogView.findViewById(R.id.tvTitulo);&#10;        TextView tvMensaje = dialogView.findViewById(R.id.tvMensaje);&#10;        LinearLayout llCorazones = dialogView.findViewById(R.id.llCorazones);&#10;        MaterialButton btnEntendido = dialogView.findViewById(R.id.btnEntendido);&#10;        &#10;        if (ivIcono != null) {&#10;            ivIcono.setImageResource(android.R.drawable.ic_menu_info_details);&#10;            ivIcono.setColorFilter(areaColor);&#10;        }&#10;        &#10;        tvTitulo.setText(&quot;¡Examen Final Desbloqueado!&quot;);&#10;        tvTitulo.setTextColor(Color.parseColor(&quot;#1F2937&quot;));&#10;        &#10;        tvMensaje.setText(&quot;¡Felicitaciones! Has desbloqueado el Examen Final de &quot; + area + &quot;.\n\n&quot; +&#10;                         &quot;El Examen Final consiste en 25 preguntas de esta área.\n\n&quot; +&#10;                         &quot;Para aprobar, necesitas responder correctamente 20 de las 25 preguntas.\n\n&quot; +&#10;                         &quot;Tendrás 3 intentos (vidas) para aprobar el examen. Si pierdes los 3 intentos, &quot; +&#10;                         &quot;podrás intentarlo nuevamente después de un tiempo.\n\n&quot; +&#10;                         &quot;Si apruebas, obtendrás una insignia por tu excelente desempeño.&quot;);&#10;        &#10;        // Configurar corazones (vidas)&#10;        llCorazones.removeAllViews();&#10;        for (int i = 0; i &lt; 3; i++) {&#10;            ImageView ivCorazon = new ImageView(this);&#10;            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(&#10;                    dp(28), dp(28)&#10;            );&#10;            params.setMargins(dp(4), 0, dp(4), 0);&#10;            ivCorazon.setLayoutParams(params);&#10;            ivCorazon.setScaleType(ImageView.ScaleType.FIT_CENTER);&#10;            ivCorazon.setImageResource(R.drawable.ic_heart_filled);&#10;            ivCorazon.setColorFilter(areaColor, android.graphics.PorterDuff.Mode.SRC_IN);&#10;            llCorazones.addView(ivCorazon);&#10;        }&#10;        &#10;        btnEntendido.setBackgroundTintList(android.content.res.ColorStateList.valueOf(areaColor));&#10;        btnEntendido.setOnClickListener(v -&gt; {&#10;            // Marcar tutorial como visto&#10;            getSharedPreferences(&quot;examen_final_tutorial&quot;, MODE_PRIVATE)&#10;                    .edit()&#10;                    .putBoolean(prefsKey, true)&#10;                    .apply();&#10;            &#10;            Toast.makeText(this, &quot;¡Felicitaciones! Desbloqueaste el Examen Final&quot;, Toast.LENGTH_LONG).show();&#10;            setResult(RESULT_OK);&#10;            finish();&#10;        });&#10;        &#10;        AlertDialog dialog = new AlertDialog.Builder(this)&#10;                .setView(dialogView)&#10;                .setCancelable(false)&#10;                .create();&#10;        &#10;        if (dialog.getWindow() != null) {&#10;            dialog.getWindow().setBackgroundDrawableResource(R.drawable.bg_overlay_oscuro);&#10;            dialog.getWindow().setLayout(&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT,&#10;                    android.view.ViewGroup.LayoutParams.MATCH_PARENT&#10;            );&#10;        }&#10;        &#10;        dialog.show();&#10;    }&#10;    &#10;    private int obtenerColorArea(String area) {&#10;        if (area == null) return Color.parseColor(&quot;#B6B9C2&quot;);&#10;        String a = area.toLowerCase().trim();&#10;        &#10;        if (a.contains(&quot;matem&quot;)) return ContextCompat.getColor(this, R.color.area_matematicas);&#10;        if (a.contains(&quot;lengua&quot;) || a.contains(&quot;lectura&quot;) || a.contains(&quot;espa&quot;) || a.contains(&quot;critica&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_lenguaje);&#10;        if (a.contains(&quot;social&quot;) || a.contains(&quot;ciudad&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_sociales);&#10;        if (a.contains(&quot;cien&quot;) || a.contains(&quot;biolo&quot;) || a.contains(&quot;fis&quot;) || a.contains(&quot;quim&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ciencias);&#10;        if (a.contains(&quot;ingl&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ingles);&#10;        &#10;        return Color.parseColor(&quot;#B6B9C2&quot;);&#10;    }&#10;    &#10;    private int obtenerColorAreaSoft(String area) {&#10;        if (area == null) return Color.parseColor(&quot;#BA68C8&quot;);&#10;        String a = area.toLowerCase().trim();&#10;        &#10;        if (a.contains(&quot;matem&quot;)) return ContextCompat.getColor(this, R.color.area_matematicas_soft);&#10;        if (a.contains(&quot;lengua&quot;) || a.contains(&quot;lectura&quot;) || a.contains(&quot;espa&quot;) || a.contains(&quot;critica&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_lenguaje_soft);&#10;        if (a.contains(&quot;social&quot;) || a.contains(&quot;ciudad&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_sociales_soft);&#10;        if (a.contains(&quot;cien&quot;) || a.contains(&quot;biolo&quot;) || a.contains(&quot;fis&quot;) || a.contains(&quot;quim&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ciencias_soft);&#10;        if (a.contains(&quot;ingl&quot;)) &#10;            return ContextCompat.getColor(this, R.color.area_ingles_soft);&#10;        &#10;        return Color.parseColor(&quot;#BA68C8&quot;);&#10;    }&#10;    &#10;    private int dp(int px) {&#10;        return (int) (px * getResources().getDisplayMetrics().density);&#10;    }&#10;&#10;    private static String readErr(ResponseBody eb) {&#10;        if (eb == null) return null;&#10;        try { return eb.string(); } catch (IOException ignored) { return null; }&#10;    }&#10;&#10;    /**&#10;     * Log utilitario para eventos de IA y preguntas.&#10;     */&#10;    private void logIAEvent(String mensaje, Integer idSesion, String area, String subtema, int nivel, int cantidadPreguntas) {&#10;        String logMsg = &quot;[IA_EVENT] &quot; + mensaje +&#10;                &quot; | idSesion=&quot; + (idSesion != null ? idSesion : &quot;null&quot;) +&#10;                &quot;, área=&quot; + (area != null ? area : &quot;null&quot;) +&#10;                &quot;, subtema=&quot; + (subtema != null ? subtema : &quot;null&quot;) +&#10;                &quot;, nivel=&quot; + nivel +&#10;                &quot;, preguntas=&quot; + cantidadPreguntas;&#10;        android.util.Log.d(&quot;QuizActivity&quot;, logMsg);&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>